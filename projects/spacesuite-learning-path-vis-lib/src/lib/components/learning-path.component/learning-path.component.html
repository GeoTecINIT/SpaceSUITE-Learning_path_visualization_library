<div
  id="path-{{data.id}}"
  (click)="onBackgroundClick()"
  class="p-2 rounded-xl w-full box-border shadow-sm"
  [ngStyle]="{
    'color': styleConfig.textColor,
    'background-color': styleConfig.backgroundColor
  }"
>
  <!-- Title -->
  <h2 class="text-2xl font-semibold mb-6">
    {{ data.label }}
  </h2>

  <!-- Courses -->
  <div
    (wheel)="onWheel($event)"
    (pointerdown)="onPointerDown($event)"
    (pointermove)="onPointerMove($event)"
    (pointerup)="onPointerUp($event)"
    (pointerleave)="onPointerUp($event)"
    class="container relative overflow-auto w-full flex flex-col gap-6"
    [ngStyle]="{
      'height': `${styleConfig.cardHeight * 1.5}px`,
      'min-height': '200px'
    }">

    <svg
      [attr.width]="'100%'" [attr.height]="'100%'"
      preserveAspectRatio="none">
      <defs>
        <marker id="arrowhead" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto" class="text-gray-400">
          <path d="M0,0 L8,4 L0,8 L2,4 z" fill="currentColor"></path>
        </marker>
      </defs>

      <!-- Pan & Zoom group -->
      <g
        [attr.transform]="'translate(' + translateX + ',' + translateY + ') scale(' + scale + ')'"
        class="pan-zoom-wrapper"
      >
        <g class="stroke-gray-400" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
          @for (l of data.links || []; track l){
            <ng-container>
              <path [attr.d]="arrowPath(l.from, l.to)" marker-end="url(#arrowhead)"></path>
            </ng-container>
          }

        </g>

        <!-- Cards layer -->
        @for (node of coursesMap | keyvalue; track node){
        <foreignObject  [attr.x]="node.value.left" [attr.y]="node.value.top" height="100%"
          [attr.width]="styleConfig.cardWidth"
          class="absolute mx-auto md:mx-0 z-30"
          >
          <div
            #cardElem
            [attr.data-id]="node.value.id"
            (click)="onCourseClick(node.value, $event)"
            [ngClass]="{
              'shadow-lg border-green-700 border-4': activeCardId() === node.value.id,
              'shadow-md': activeCardId() !== node.value.id
            }"
            [ngStyle]="{
              'min-height': `${styleConfig.cardHeight * 1.3}px`
            }"
            class="card p-4 rounded-lg mb-4 bg-white/70 shadow transform transition border-2 border-gray-300 cursor-pointer hover:border-green-700">

            <div class="grid grid-cols-6 gap-1">
              <svg class="col-start-1 w-6 h-6 text-green-700 cursor-pointer"
                (mouseover)="onCourseHover(node.value, $event)"
                (mouseout)="onCourseHover(node.value, $event)"
                aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11h2v5m-2 0h4m-2.592-8.5h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
              </svg>
              <h3 class="col-start-2 col-span-5 col-end-12font-semibold truncate text-base/5 font-semibold">{{ node.value.label }}</h3>
            </div>
            <div class="flex items-center justify-between">
              <p class="text-sm mt-2 wrap-break-word line-clamp-2 prose max-w-none">{{ node.value.description }}</p>
            </div>
            <p class="text-sm text-gray-400 my-4">
              {{node.value.learning_objectives?.length}} Learning objectives and {{getConcepts(node.value).length}} Concepts
            </p>
            <button
              class="mt-4 px-3 py-1 rounded text-white text-sm bg-green-900 hover:bg-green-700 cursor-pointer"
              [ngClass]="{
                'block': activeCardId() === node.value.id,
                'hidden': activeCardId() !== node.value.id,
              }"
              (click)="onViewCourse(node.value, $event)">
              View Course
            </button>
          </div>
        </foreignObject>
        }
      </g>
    </svg>


    <!-- Tooltip -->
    @if(activeTooltip) {
    <div
      class="fixed z-50 p-2 bg-gray-800 text-white text-sm rounded shadow-lg pointer-events-none"
      [style.left.px]="tooltipX"
      [style.top.px]="tooltipY">
      {{ activeTooltip }}
    </div>
    }
  </div>
</div>

